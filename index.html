<!doctype html>
<html lang="ja">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>広島駅バスサイネージ</title>
    <style>
      :root {
        color-scheme: light;
        font-family: "Hiragino Sans", "Noto Sans JP", "Noto Sans JP", system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
      }
      * {
        box-sizing: border-box;
      }
      body {
        margin: 0;
        background: radial-gradient(circle at top, #eef4ff 0%, #f5f7fb 55%, #f3f0ed 100%);
        color: #1f1f1f;
        min-height: 100vh;
        padding: 2rem 1rem 3rem;
      }
      .layout {
        max-width: 1280px;
        margin: 0 auto;
        display: grid;
        grid-template-columns: minmax(320px, 52%) minmax(320px, 1fr);
        gap: 1.5rem;
      }
      .panel {
        background: rgba(255, 255, 255, 0.96);
        border-radius: 18px;
        padding: 1.6rem;
        box-shadow: 0 20px 50px rgba(30, 49, 84, 0.14);
      }
      .map-panel h1,
      .map-panel p {
        margin: 0 0 0.6rem;
      }
      .map-panel h1 {
        font-size: clamp(1.2rem, 2.3vw, 1.7rem);
        letter-spacing: 0.08em;
      }
      .map-panel p {
        color: #4c566a;
        font-size: 0.95rem;
      }
      .map-wrapper {
        position: relative;
        width: 100%;
        margin-top: 0.5rem;
        border-radius: 16px;
        overflow: hidden;
        background: #dfe3ec;
      }
      .map-wrapper img {
        width: 100%;
        display: block;
      }
      .marker {
        position: absolute;
        border-radius: 6px;
        pointer-events: none;
        background: rgba(255, 181, 72, 0.35);
        box-shadow: 0 0 0 1px rgba(255, 255, 255, 0.7);
        transition: opacity 0.2s ease, transform 0.2s ease;
        z-index: 1;
      }
      .marker::after {
        content: attr(data-stop-id);
        position: absolute;
        inset: 0;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        font-size: min(2vw, 18px);
        color: #fff;
        text-shadow: 0 0 3px rgba(0, 0, 0, 0.3);
      }
      .marker.active-kami {
        background: rgba(53, 94, 185, 0.9);
        animation: blinkKami 1s steps(1) infinite;
      }
      .marker.active-hachi {
        background: rgba(255, 136, 0, 0.9);
        animation: blinkHachi 1s steps(1) infinite;
      }
      @keyframes blinkKami {
        0%, 45% { opacity: 1; }
        55%, 100% { opacity: 0.2; }
      }
      @keyframes blinkHachi {
        0%, 45% { opacity: 1; }
        55%, 100% { opacity: 0.2; }
      }
      .callout-layer,
      .callout-lines {
        position: absolute;
        inset: 0;
        pointer-events: none;
      }
      .callout-lines {
        width: 100%;
        height: 100%;
        z-index: 2;
      }
      .callout-layer {
        z-index: 3;
      }
      .callout-line {
        stroke-width: 0.6;
        stroke-linecap: round;
        opacity: 0.8;
      }
      .callout-line--kami {
        stroke: #2c56d2;
      }
      .callout-line--hachi {
        stroke: #f68b1f;
      }
      .callout {
        position: absolute;
        transform: translate(-50%, -50%);
        display: flex;
        align-items: center;
        justify-content: center;
        width: clamp(28px, 3vw, 44px);
        aspect-ratio: 1;
        border-radius: 50%;
        color: #fff;
        font-weight: 700;
        font-size: clamp(1rem, 1.5vw, 1.3rem);
        text-shadow: 0 3px 6px rgba(0, 0, 0, 0.3);
        animation: iconBlink 1s steps(1) infinite;
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.25);
      }
      .callout--kami {
        background: #2c56d2;
      }
      .callout--hachi {
        background: #f68b1f;
      }
      @keyframes iconBlink {
        0%, 45% { opacity: 1; }
        55%, 100% { opacity: 0.2; }
      }
      .info-panel header {
        display: flex;
        flex-direction: column;
        gap: 0.4rem;
        margin-bottom: 1rem;
      }
      .info-panel h2 {
        margin: 0;
        font-size: 1.1rem;
      }
      .time-form {
        display: flex;
        flex-wrap: wrap;
        gap: 0.6rem;
        align-items: center;
      }
      .time-form label {
        font-size: 0.85rem;
        color: #4e566a;
        flex-basis: 100%;
      }
      .time-form input[type="time"] {
        font-size: 1.1rem;
        padding: 0.3rem 0.5rem;
      }
      .time-form button {
        background: #1f7aec;
        border: none;
        color: #fff;
        padding: 0.45rem 0.9rem;
        border-radius: 6px;
        font-size: 0.95rem;
        cursor: pointer;
      }
      .time-form button.secondary {
        background: #e2e5ec;
        color: #2e3442;
      }
      .hint {
        margin: 0.2rem 0 1rem;
        font-size: 0.85rem;
        color: #6c7283;
      }
      .next-stops {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
        gap: 0.8rem;
        margin-bottom: 1.2rem;
      }
      .next-card {
        border-radius: 12px;
        background: #f6f7fb;
        padding: 0.9rem;
        display: flex;
        flex-direction: column;
        gap: 0.6rem;
        border: 1px solid rgba(68, 82, 122, 0.08);
      }
      .next-main {
        display: flex;
        flex-wrap: wrap;
        gap: 0.6rem;
        align-items: center;
      }
      .next-time {
        font-size: clamp(1.6rem, 4vw, 2.8rem);
        font-variant-numeric: tabular-nums;
        font-weight: 700;
      }
      .next-platforms {
        display: flex;
        flex-wrap: wrap;
        gap: 0.4rem;
        flex: 1;
      }
      .platform-big {
        flex: 0 1 calc(50% - 0.4rem);
        min-width: 70px;
        background: #fff;
        border-radius: 12px;
        text-align: center;
        font-size: clamp(1.3rem, 3vw, 2.3rem);
        font-weight: 700;
        padding: 0.2rem 0.4rem;
        color: #1f1f1f;
        box-shadow: inset 0 0 0 2px rgba(0, 0, 0, 0.08);
      }
      .platform-big small {
        display: block;
        font-size: 0.65rem;
        color: #666;
      }
      .next-card h3 {
        margin: 0;
        font-size: 1rem;
        display: flex;
        align-items: center;
        gap: 0.4rem;
      }
      .next-card .badge {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        width: 1.8em;
        height: 1.8em;
        border-radius: 12px;
        color: #fff;
        font-weight: 700;
      }
      .badge-kami {
        background: #2c56d2;
      }
      .badge-hachi {
        background: #f68b1f;
      }
      .next-card .time {
        font-size: 1.6rem;
        font-variant-numeric: tabular-nums;
      }
      .next-card .platform {
        font-size: 0.95rem;
        color: #3f4657;
      }
      .next-card .meta {
        font-size: 0.85rem;
        color: #6b7082;
      }
      .timeline {
        border-radius: 12px;
        border: 1px solid rgba(0, 0, 0, 0.06);
        background: #fff;
        padding: 0.8rem;
        max-height: 60vh;
        overflow: auto;
      }
      .timeline h4 {
        margin: 0 0 0.4rem;
        font-size: 0.95rem;
        color: #6f7688;
      }
      .trip-list {
        list-style: none;
        margin: 0;
        padding: 0;
        display: flex;
        flex-direction: column;
        gap: 0.7rem;
      }
      .trip {
        display: grid;
        grid-template-columns: minmax(90px, 110px) minmax(90px, 110px) 1fr;
        gap: 0.6rem;
        align-items: center;
        padding: 0.4rem 0.2rem;
        border-bottom: 1px dashed rgba(0, 0, 0, 0.08);
      }
      .trip:last-child {
        border-bottom: none;
      }
      .trip-time {
        font-size: 1.4rem;
        font-variant-numeric: tabular-nums;
        font-weight: 600;
      }
      .trip-platform {
        font-size: 1.4rem;
        font-variant-numeric: tabular-nums;
        font-weight: 600;
        text-align: center;
        color: #1c263d;
      }
      .trip-body {
        display: flex;
        flex-direction: column;
        gap: 0.2rem;
      }
      .trip-route {
        font-weight: 600;
      }
      .trip-headsign {
        font-size: 0.9rem;
        color: #666d7e;
      }
      .trip-meta {
        display: flex;
        flex-wrap: wrap;
        gap: 0.3rem;
        font-size: 0.85rem;
      }
      .chip {
        padding: 0.1rem 0.5rem;
        border-radius: 999px;
        background: #f0f3fa;
        color: #374053;
      }
      .chip-platform {
        background: #232c3d;
        color: #fff;
      }
      .chip-kami {
        background: rgba(44, 86, 210, 0.12);
        color: #1e3b99;
      }
      .chip-hachi {
        background: rgba(246, 139, 31, 0.12);
        color: #b15400;
      }
      .error {
        color: #cc1f1f;
        margin: 0.5rem 0;
        font-size: 0.9rem;
      }
      .trip--soon {
        animation: soonGlow 1.2s ease-in-out infinite;
        border-radius: 10px;
        padding: 0.6rem 0.4rem;
      }
      @keyframes soonGlow {
        0% {
          background: #fff6d5;
          box-shadow: 0 0 10px rgba(255, 198, 0, 0.25);
        }
        100% {
          background: #ffe48a;
          box-shadow: 0 0 30px rgba(255, 198, 0, 0.45);
        }
      }
      @media (max-width: 960px) {
        .layout {
          grid-template-columns: 1fr;
        }
        .map-panel {
          order: 2;
        }
        .info-panel {
          order: 1;
        }
      }
    </style>
  </head>
  <body>
    <main class="layout">
      <section class="map-panel panel">
        <h1>バスのりば案内（広島駅南口）</h1>
        <div class="map-wrapper" id="map-wrapper">
          <img src="test2.png" alt="広島駅南口バスのりばマップ">
          <svg class="callout-lines" id="callout-lines" viewBox="0 0 100 100" preserveAspectRatio="none"></svg>
          <div class="callout-layer" id="callout-layer"></div>
        </div>
      </section>
      <section class="info-panel panel">
        <header>
          <h2>紙屋町 / 八丁堀 行きバス サイネージ</h2>
          <form class="time-form" id="time-form">
            <label for="time-input">表示基準時刻（自由入力）</label>
            <input type="time" id="time-input" step="60" value="09:00">
            <button type="button" id="apply-time">更新</button>
            <button type="button" id="now-time" class="secondary">現在時刻</button>
          </form>
          <p class="hint">データ: site/hiroshima_station_weekend_timetable.csv（週末ダイヤ）</p>
        </header>
        <div class="next-stops">
          <article class="next-card" id="card-kami">
            <h3><span class="badge badge-kami">紙</span>紙屋町通過</h3>
            <div class="next-main">
              <div class="next-time" data-field="time">--:--</div>
              <div class="next-platforms" data-field="platforms">
                <span class="platform-big">--</span>
              </div>
            </div>
            <div class="meta" data-field="meta">最初のバスを検索しています…</div>
          </article>
          <article class="next-card" id="card-hachi">
            <h3><span class="badge badge-hachi">八</span>八丁堀通過</h3>
            <div class="next-main">
              <div class="next-time" data-field="time">--:--</div>
              <div class="next-platforms" data-field="platforms">
                <span class="platform-big">--</span>
              </div>
            </div>
            <div class="meta" data-field="meta">最初のバスを検索しています…</div>
          </article>
        </div>
        <div class="timeline">
          <h4>昇順リスト（全系統）</h4>
          <ul class="trip-list" id="trip-list"></ul>
          <p class="error" id="error" hidden></p>
        </div>
      </section>
    </main>
    <script src="timetable_fallback.js"></script>
    <script>
      const STOP_CONFIGS = {
        1: { left: 67.38, top: 40.03, width: 3.67, height: 2.83 },
        2: { left: 67.38, top: 35.66, width: 3.67, height: 2.83 },
        3: { left: 67.38, top: 31.29, width: 3.67, height: 2.78 },
        4: { left: 67.38, top: 26.97, width: 3.67, height: 2.78 },
        5: { left: 67.38, top: 22.69, width: 3.67, height: 2.87 },
        6: { left: 46.38, top: 35.87, width: 3.56, height: 2.83 },
        7: { left: 46.38, top: 31.72, width: 3.62, height: 2.74 },
        8: { left: 46.38, top: 27.31, width: 3.62, height: 2.91 },
        9: { left: 46.38, top: 23.07, width: 3.62, height: 2.87 },
        16: { left: 37.72, top: 92.29, width: 4.44, height: 3.38 },
        17: { left: 24.89, top: 64.51, width: 4.22, height: 3.25 },
        20: { left: 25.66, top: 28.77, width: 4.5, height: 3.34 },
        21: { left: 37.94, top: 6.59, width: 4.61, height: 3.42 },
        23: { left: 25, top: 4.45, width: 4.44, height: 3.25 }
      };
      const MAP_CENTER = { x: 50, y: 50 };
      const CALLOUT_DISTANCE = 8;
      const CALLOUT_PERP_SPACING = 2.4;
      const CALLOUT_SLOT_SEQUENCE = [0, 1, -1, 2, -2, 3, -3];

      const mapWrapper = document.getElementById("map-wrapper");
      const calloutLayer = document.getElementById("callout-layer");
      const calloutLines = document.getElementById("callout-lines");
      const tripListEl = document.getElementById("trip-list");
      const timeInput = document.getElementById("time-input");
      const applyTimeBtn = document.getElementById("apply-time");
      const nowBtn = document.getElementById("now-time");
      const errorEl = document.getElementById("error");
      const kamiCard = document.getElementById("card-kami");
      const hachiCard = document.getElementById("card-hachi");
      const DISPLAY_COUNT = 10;

      let uidCounter = 0;
      const nextUid = () => `trip-${uidCounter++}`;
      const dedupeByPlatform = (trips) => {
        const seen = new Set();
        return trips.filter((trip) => {
          if (!trip.platform || seen.has(trip.platform)) {
            return false;
          }
          seen.add(trip.platform);
          return true;
        });
      };

      const markers = new Map();
      Object.entries(STOP_CONFIGS).forEach(([stopId, box]) => {
        const marker = document.createElement("div");
        marker.className = "marker";
        marker.dataset.stopId = stopId;
        marker.style.left = `${box.left}%`;
        marker.style.top = `${box.top}%`;
        marker.style.width = `${box.width}%`;
        marker.style.height = `${box.height}%`;
        box.centerX = box.left + box.width / 2;
        box.centerY = box.top + box.height / 2;
        mapWrapper.appendChild(marker);
        markers.set(String(stopId), marker);
      });

      const state = {
        trips: [],
        sortedTrips: [],
      };

      init();

      async function init() {
        await loadTimetable();
        setDefaultTime();
        updateDisplay();
        applyTimeBtn.addEventListener("click", updateDisplay);
        timeInput.addEventListener("change", () => applyTimeBtn.click());
        nowBtn.addEventListener("click", () => {
          setTimeToCurrent();
          updateDisplay();
        });
      }

      async function loadTimetable() {
        try {
          const csvText = await resolveCsvText();
          const rows = parseCsv(csvText);
          state.trips = rows.map(normalizeRow).filter(Boolean);
          state.sortedTrips = [...state.trips].sort((a, b) => a.minutes - b.minutes);
        } catch (error) {
          errorEl.hidden = false;
          errorEl.textContent = `時刻表の読み込みに失敗しました: ${error.message}`;
          console.error(error);
        }
      }

      async function resolveCsvText() {
        if (window.location.protocol !== "file:") {
          try {
            const response = await fetch("hiroshima_station_weekend_timetable.csv", {
              cache: "no-store",
            });
            if (!response.ok) {
              throw new Error(`HTTP ${response.status}`);
            }
            return await response.text();
          } catch (error) {
            console.warn("CSV fetch failed, falling back to embedded data.", error);
          }
        }
        if (typeof window.HIROSHIMA_TIMETABLE_CSV === "string" && window.HIROSHIMA_TIMETABLE_CSV.trim()) {
          return window.HIROSHIMA_TIMETABLE_CSV;
        }
        throw new Error("CSV を読み込めませんでした。ローカル閲覧時は http サーバー経由で開いてください。");
      }

      function parseCsv(text) {
        const lines = text.trim().split(/\r?\n/).filter(Boolean);
        const header = lines.shift().replace(/\r/g, "").split(",");
        return lines.map((line) => {
          const cleanLine = line.replace(/\r/g, "");
          const cells = cleanLine.split(",");
          const record = {};
          header.forEach((key, idx) => {
            record[key] = cells[idx] ?? "";
          });
          return record;
        });
      }

      function normalizeRow(row) {
        if (!row || !row.hiroshima_departure_time) {
          return null;
        }
        const time = row.hiroshima_departure_time.trim();
        const [h = "0", m = "0"] = time.split(":");
        const minutes = Number(h) * 60 + Number(m);
        return {
          id: row.trip_id || nextUid(),
          route: row.route_name || "系統名未定",
          headsign: row.trip_headsign || "行先未定",
          platform: (row.platform_code || "").trim(),
          time,
          minutes,
          stopsKami: row.stops_kamiyacho_after_hiroshima === "1",
          stopsHachi: row.stops_hatchobori_after_hiroshima === "1",
        };
      }

      function setDefaultTime() {
        if (state.sortedTrips.length === 0) {
          return;
        }
        const now = new Date();
        const hh = String(now.getHours()).padStart(2, "0");
        const mm = String(now.getMinutes()).padStart(2, "0");
        timeInput.value = `${hh}:${mm}`;
      }

      function setTimeToCurrent() {
        const now = new Date();
        const hh = String(now.getHours()).padStart(2, "0");
        const mm = String(now.getMinutes()).padStart(2, "0");
        timeInput.value = `${hh}:${mm}`;
      }

      function updateDisplay() {
        if (!state.sortedTrips.length) {
          return;
        }
        const referenceMinutes = getReferenceMinutes();
        const upcoming = getUpcomingTrips(referenceMinutes, DISPLAY_COUNT);
        renderTimeline(upcoming);
        const nextKami = getNextTripsGroup("stopsKami", referenceMinutes);
        const nextHachi = getNextTripsGroup("stopsHachi", referenceMinutes);
        updateCard(kamiCard, nextKami, "紙屋町");
        updateCard(hachiCard, nextHachi, "八丁堀");
        updateMapHighlights(nextKami, nextHachi);
      }

      function getReferenceMinutes() {
        const [h = "0", m = "0"] = (timeInput.value || "00:00").split(":");
        return Number(h) * 60 + Number(m);
      }

      function getUpcomingTrips(referenceMinutes, count) {
        return state.sortedTrips
          .filter((trip) => trip.platform)
          .map((trip) => ({
            ...trip,
            eta: minutesUntil(trip.minutes, referenceMinutes),
          }))
          .sort((a, b) => a.eta - b.eta)
          .slice(0, count);
      }

      function minutesUntil(minutes, reference) {
        let diff = minutes - reference;
        if (diff < 0) {
          diff += 24 * 60;
        }
        return diff;
      }

      function getNextTripsGroup(key, referenceMinutes) {
        const trips = state.sortedTrips.filter((trip) => trip[key] && trip.platform);
        if (!trips.length) {
          return [];
        }
        let bestTrip = trips[0];
        let bestDiff = minutesUntil(bestTrip.minutes, referenceMinutes);
        trips.forEach((trip) => {
          const diff = minutesUntil(trip.minutes, referenceMinutes);
          if (diff < bestDiff) {
            bestDiff = diff;
            bestTrip = trip;
          }
        });
        const threshold = bestDiff + 3;
        return trips
          .map((trip) => ({
            ...trip,
            eta: minutesUntil(trip.minutes, referenceMinutes),
          }))
          .filter((trip) => trip.eta >= bestDiff && trip.eta <= threshold)
          .sort((a, b) => a.eta - b.eta || a.minutes - b.minutes);
      }

      function renderTimeline(trips) {
        tripListEl.innerHTML = "";
        if (!trips.length) {
          const empty = document.createElement("li");
          empty.textContent = "表示できる便がありません。";
          tripListEl.appendChild(empty);
          return;
        }
        const fragment = document.createDocumentFragment();
        trips.forEach((trip) => {
          const li = document.createElement("li");
          li.className = "trip";
          if (trip.eta !== undefined && trip.eta <= 3) {
            li.classList.add("trip--soon");
          }
          const time = document.createElement("div");
          time.className = "trip-time";
          time.textContent = trip.time.slice(0, 5);
          const platformBig = document.createElement("div");
          platformBig.className = "trip-platform";
          platformBig.textContent = trip.platform || "-";
          const body = document.createElement("div");
          body.className = "trip-body";
          const route = document.createElement("div");
          route.className = "trip-route";
          route.textContent = trip.route;
          const headsign = document.createElement("div");
          headsign.className = "trip-headsign";
          headsign.textContent = trip.headsign;
          const meta = document.createElement("div");
          meta.className = "trip-meta";
          const platform = document.createElement("span");
          platform.className = "chip chip-platform";
          platform.textContent = `のりば ${trip.platform || "-"}`;
          meta.append(platform);
          if (trip.stopsKami) {
            const kamiChip = document.createElement("span");
            kamiChip.className = "chip chip-kami";
            kamiChip.textContent = "紙経由";
            meta.append(kamiChip);
          }
          if (trip.stopsHachi) {
            const hachiChip = document.createElement("span");
            hachiChip.className = "chip chip-hachi";
            hachiChip.textContent = "八経由";
            meta.append(hachiChip);
          }
          body.append(route, headsign, meta);
          li.append(time, platformBig, body);
          fragment.append(li);
        });
        tripListEl.appendChild(fragment);
      }

      function updateCard(card, trips, label) {
        const timeEl = card.querySelector('[data-field="time"]');
        const platformsEl = card.querySelector('[data-field="platforms"]');
        const metaEl = card.querySelector('[data-field="meta"]');
        platformsEl.innerHTML = "";
        if (!trips.length) {
          timeEl.textContent = "--:--";
          metaEl.textContent = `${label} を通過する便が見つかりません。`;
          const placeholder = document.createElement("span");
          placeholder.className = "platform-big";
          placeholder.textContent = "--";
          platformsEl.appendChild(placeholder);
          return;
        }
        const firstTrip = trips[0];
        timeEl.textContent = firstTrip.time.slice(0, 5);
        const displayTrips = dedupeByPlatform(trips);
        if (displayTrips.length === 0) {
          metaEl.textContent = `${label} を通過する便が見つかりません。`;
          timeEl.textContent = "--:--";
          const placeholder = document.createElement("span");
          placeholder.className = "platform-big";
          placeholder.textContent = "--";
          platformsEl.appendChild(placeholder);
          return;
        }
        displayTrips.forEach((trip) => {
          const badge = document.createElement("span");
          badge.className = "platform-big";
          badge.textContent = trip.platform;
          platformsEl.appendChild(badge);
        });
        const summaries = trips
          .map((trip) => `${trip.route}（${trip.headsign || "行先調整中"}）`)
          .slice(0, 3);
        const moreCount = trips.length - summaries.length;
        metaEl.textContent =
          moreCount > 0
            ? `${summaries.join(" / ")} / 他 ${moreCount} 便`
            : summaries.join(" / ");
      }

      function updateMapHighlights(kamiTrips, hachiTrips) {
        markers.forEach((marker) => {
          marker.classList.remove("active-kami", "active-hachi");
        });
        calloutLayer.innerHTML = "";
        while (calloutLines.firstChild) {
          calloutLines.removeChild(calloutLines.firstChild);
        }
        const slotUsage = new Map();
        const highlightSets = [
          { trips: kamiTrips, markerClass: "active-kami", calloutClass: "callout--kami", lineClass: "callout-line--kami", label: "紙" },
          { trips: hachiTrips, markerClass: "active-hachi", calloutClass: "callout--hachi", lineClass: "callout-line--hachi", label: "八" },
        ];
        highlightSets.forEach(({ trips, markerClass, calloutClass, lineClass, label }) => {
          dedupeByPlatform(trips).forEach((trip) => {
            const stopId = trip.platform;
            const config = STOP_CONFIGS[stopId];
            if (!stopId || !config) {
              return;
            }
            const marker = markers.get(String(stopId));
            marker?.classList.add(markerClass);
            const slot = nextSlotForStop(slotUsage, stopId);
            const { x, y } = computeCalloutPosition(config, slot);
            addCallout(label, calloutClass, x, y);
            addCalloutLine(config, lineClass, x, y);
          });
        });
      }

      function nextSlotForStop(cache, stopId) {
        const used = cache.get(stopId) || 0;
        cache.set(stopId, used + 1);
        return CALLOUT_SLOT_SEQUENCE[used] ?? 0;
      }

      function computeCalloutPosition(config, slotOffset) {
        const centerX = config.centerX;
        const centerY = config.centerY;
        let dx = centerX - MAP_CENTER.x;
        let dy = centerY - MAP_CENTER.y;
        let length = Math.hypot(dx, dy);
        if (!length) {
          dx = 0;
          dy = -1;
          length = 1;
        }
        dx /= length;
        dy /= length;
        let targetX = centerX + dx * CALLOUT_DISTANCE;
        let targetY = centerY + dy * CALLOUT_DISTANCE;
        const perpX = -dy;
        const perpY = dx;
        targetX += perpX * CALLOUT_PERP_SPACING * slotOffset;
        targetY += perpY * CALLOUT_PERP_SPACING * slotOffset;
        targetX = Math.min(97, Math.max(3, targetX));
        targetY = Math.min(97, Math.max(3, targetY));
        return { x: targetX, y: targetY };
      }

      function addCallout(label, className, x, y) {
        const el = document.createElement("div");
        el.className = `callout ${className}`;
        el.style.left = `${x}%`;
        el.style.top = `${y}%`;
        el.textContent = label;
        calloutLayer.appendChild(el);
      }

      function addCalloutLine(config, className, x, y) {
        const line = document.createElementNS("http://www.w3.org/2000/svg", "line");
        line.setAttribute("x1", x);
        line.setAttribute("y1", y);
        line.setAttribute("x2", config.centerX);
        line.setAttribute("y2", config.centerY);
        line.classList.add("callout-line", className);
        calloutLines.appendChild(line);
      }
    </script>
  </body>
</html>
